name: CI

on:
  push:
    branches: [ master ]
  pull_request: ~
  workflow_dispatch: ~

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        javaversion: [ "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19" ]
    steps:
      - uses: actions/checkout@v3
      - name: Load Maven dependencies cache
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-build${{ matrix.javaversion }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Install dependencies
        run: make install
      - name: Set up Java ${{ matrix.javaversion }}
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: ${{ matrix.javaversion }}
      - name: Build and test with Maven
        run: EASYPOST_TEST_API_KEY=123 EASYPOST_PROD_API_KEY=123 make coverage
      - name: Load Rust cache
        if: github.ref == 'refs/heads/master'
        uses: Swatinem/rust-cache@v2
      - name: Install grcov
        if: github.ref == 'refs/heads/master'
        run: cargo install grcov
      - name: Convert coverage report
        if: github.ref == 'refs/heads/master'
        run: grcov target/site/jacoco/jacoco.xml --source-dir ./ --ignore "target/*" > coverage.lcov
      - name: Coveralls
        if: github.ref == 'refs/heads/master'
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: "./coverage.lcov"
  lint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Set up Java ${{ matrix.javaversion }}
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: 9 # Running on Java 9 since Error Prone 2.10.0 with our config is only compatible with JDK 9+
      - name: Run CheckStyle checks
        uses: nikitasavinov/checkstyle-action@0.5.1
        with:
          level: error
          fail_on_error: true
          checkstyle_config: easypost_java_style.xml
          tool_name: "style_enforcer"
      - name: Run Error Prone
        run: run-error-prone.sh
  security:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Load Maven dependencies and CVE database cache
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository # The CVE database is included in the Maven repository folder
          key: ${{ runner.os }}-maven-security-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Run security analysis
        run: make scan
      - name: Upload Test results
        uses: actions/upload-artifact@master
        with:
          name: DependencyCheck report
          path: ${{github.workspace}}/target/dependency-check-report.html
